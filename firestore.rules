rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper Functions
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isAdmin() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == "admin";
    }

    // Safety Net: Deny everything by default
    match /{document=**} {
      allow read, write: if false;
    }

    // Users Collection (The Role Directory)
    match /users/{userId} {
      allow read: if isAuthenticated() && (request.auth.uid == userId || isAdmin());
      
      // CREATE: strict check that role is 'user'
      allow create: if isAuthenticated() && request.auth.uid == userId && 
        request.resource.data.role == 'user';

      // UPDATE: deny any changes to the 'role' field
      allow update: if isAuthenticated() && request.auth.uid == userId &&
        (!request.resource.data.diff(resource.data).affectedKeys().hasAny(['role']));

      // ADMIN: Full Access (Overrides above)
      allow write: if isAdmin();
    }

    // Applicants Collection (Linked to Floating Form)
    match /applicants/{applicantId} {
      // 1. Admin Access: Only Admins can READ and UPDATE
      allow read, update: if isAdmin();

      // 2. Public Access: Anyone can CREATE (if valid)
      allow create: if isValidApplication();
      
      // 3. No one can DELETE (Safety check)
      allow delete: if false;
    }

    // Validation Logic
    function isValidApplication() {
      let incoming = request.resource.data;
      
      return 
        // Must have these fields
        incoming.keys().hasAll(['name', 'email', 'resumeUrl', 'status']) &&
        
        // Data Type Checks
        incoming.name is string && incoming.name.size() > 0 &&
        incoming.email is string && incoming.email.size() > 0 &&
        incoming.resumeUrl is string && incoming.resumeUrl.size() > 0 &&
        
        // Status defaults to 'new'
        incoming.status == 'new';
    }
  }
}
